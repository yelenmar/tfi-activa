rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================
    // USUARIOS
    // ==========================
    match /usuarios/{userId} {
      // Lectura pública (para listar usuarios en notificaciones y perfiles)
      allow read: if true;
      // Escritura abierta (tu app usa IDs derivados de email, no de Firebase Auth)
      allow write: if true;
    }

    // ==========================
    // PERFILES
    // ==========================
    match /perfiles/{perfilId} {
      // Lectura pública (para mostrar organizadores y participantes)
      allow read: if true;
      // Escritura abierta (tu app gestiona perfiles con IDs locales)
      allow write: if true;
    }

    // ==========================
    // EVENTOS
    // ==========================
    match /eventos/{eventoId} {
      // Lectura pública (necesaria para listar eventos en inicio, favoritos, perfil)
      allow read: if true;
      // Escritura abierta (tu app valida permisos en cliente; organizador crea/edita/borra)
      allow write: if true;
    }

    // ==========================
    // FAVORITOS
    // ==========================
    match /favoritos/{favId} {
      // Lectura y escritura abiertas (la app filtra por userId en queries y localmente)
      allow read, write: if true;
    }

    // ==========================
    // HISTORIAL
    // ==========================
    match /historial/{histId} {
      // Lectura abierta (la app filtra en cliente por prefijo de ID userId_eventoId_tipo)
      allow read: if true;
      // Escritura abierta (crear/actualizar/borrar entradas de historial propio y ajeno para reparaciones)
      allow write: if true;
    }

    // ==========================
    // NOTIFICACIONES
    // ==========================
    match /notificaciones/{notifId} {
      // Lectura y escritura abiertas (sistema de notificaciones crea para cualquier usuario)
      allow read, write: if true;
    }

    // ==========================
    // NOTIFICACIONES_ULTIMA (anti-duplicados)
    // ==========================
    match /notificaciones_ultima/{uniqId} {
      // Lectura y escritura abiertas (marcadores de última notificación enviada)
      allow read, write: if true;
    }

    // ==========================
    // VALORACIONES
    // ==========================
    match /valoraciones/{valId} {
      // Lectura pública (para calcular promedios)
      allow read: if true;
      // Escritura abierta (participantes valoran eventos pasados)
      allow write: if true;
    }

    // ==========================
    // EMAIL QUEUE (opcional)
    // ==========================
    match /emailQueue/{emailId} {
      // Lectura y escritura abiertas si usas esta colección
      allow read, write: if true;
    }

    // ==========================
    // CUALQUIER OTRA COLECCIÓN NO DECLARADA
    // ==========================
    match /{document=**} {
      // Bloquear acceso a rutas no definidas explícitamente arriba
      allow read, write: if false;
    }
  }
}
